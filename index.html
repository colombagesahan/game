<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sri Lanka's Most Genius Kids üá±üá∞</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #F8FAFC; color: #1e293b; overflow-x: hidden; }
        
        /* Silicon Valley Glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-dark { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Gradients */
        .gold-gradient { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); box-shadow: 0 10px 20px -5px rgba(253, 185, 49, 0.5); }
        .silver-gradient { background: linear-gradient(135deg, #E0E0E0 0%, #BDBDBD 100%); }
        .bronze-gradient { background: linear-gradient(135deg, #CD7F32 0%, #A0522D 100%); }
        .blue-gradient { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); }
        
        /* Animations */
        .blob { position: absolute; filter: blur(50px); z-index: -1; animation: float 10s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(20px, 20px); } }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-press { transition: all 0.1s; transform: translateY(0); }
        .btn-press:active { transform: translateY(3px); }

        [x-cloak] { display: none !important; }
    </style>
</head>

<body x-data="geniusApp()" x-init="initApp()" class="selection:bg-yellow-200" x-cloak>

    <!-- BACKGROUND BLOBS -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="blob bg-blue-200 w-96 h-96 rounded-full top-0 left-0 opacity-40"></div>
        <div class="blob bg-purple-200 w-96 h-96 rounded-full bottom-0 right-0 opacity-40 animation-delay-2000"></div>
        <div class="blob bg-yellow-100 w-64 h-64 rounded-full top-1/2 left-1/2 opacity-40"></div>
    </div>

    <!-- ================== NAVBAR ================== -->
    <nav class="fixed top-0 w-full z-50 glass shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
            <div @click="changeView('landing')" class="flex items-center gap-2 cursor-pointer">
                <div class="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-blue-500/30">
                    <i class="fas fa-brain"></i>
                </div>
                <div>
                    <h1 class="font-extrabold text-lg tracking-tight leading-none text-slate-800">Genius<span class="text-blue-600">.LK</span></h1>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">National Rank</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <template x-if="user">
                     <div class="flex items-center gap-2" @click="changeView('dashboard')">
                        <div class="text-right hidden sm:block">
                            <p class="text-xs font-bold text-slate-800" x-text="profile?.childName || 'Student'"></p>
                            <p class="text-[10px] text-slate-500" x-text="profile?.childCode || ''"></p>
                        </div>
                        <img :src="user.photoURL" class="w-9 h-9 rounded-full border-2 border-white shadow-md cursor-pointer">
                     </div>
                </template>
                <template x-if="!user">
                    <button @click="login()" class="bg-slate-900 text-white px-5 py-2 rounded-full text-xs font-bold shadow-xl hover:bg-slate-800 transition">Login</button>
                </template>
            </div>
        </div>
    </nav>

    <!-- ================== VIEW: LANDING PAGE ================== -->
    <div x-show="view === 'landing'" class="pt-24 pb-12 px-4 max-w-6xl mx-auto fade-in">
        
        <!-- SEARCH BAR -->
        <div class="max-w-md mx-auto mb-10 relative z-20">
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                <div class="relative bg-white rounded-2xl p-2 flex shadow-xl">
                    <input x-model="searchQuery" type="text" placeholder="Search Student Code (e.g. SG-1001)" class="flex-1 p-3 outline-none text-sm font-bold text-slate-700 placeholder-slate-400 bg-transparent">
                    <button @click="searchStudent()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-xl font-bold text-sm transition shadow-lg">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- HERO HEADER -->
        <div class="text-center mb-12">
            <div class="inline-flex items-center gap-2 bg-yellow-100 border border-yellow-200 text-yellow-800 px-4 py-1.5 rounded-full text-xs font-bold mb-4 animate-bounce">
                <i class="fas fa-crown"></i> Official Scholarship Ranking 2026
            </div>
            <h1 class="text-4xl md:text-6xl font-black text-slate-900 mb-4 leading-tight">
                Sri Lanka's Most <br>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">Genius Top 100 Kids</span>
            </h1>
            <p class="text-slate-500 font-medium text-lg max-w-2xl mx-auto">
                Join 5,000+ students from Royal, Visakha, & Ananda. <br>Prove your child is the smartest in the island.
            </p>
        </div>

        <!-- ISLAND TOP 3 PODIUM (Special Display) -->
        <div class="grid grid-cols-3 gap-2 md:gap-6 max-w-4xl mx-auto mb-16 items-end">
            
            <!-- Rank 2 -->
            <div class="relative order-1">
                <div class="bg-white rounded-3xl p-4 shadow-xl border-b-8 border-gray-300 text-center relative z-10 transform hover:-translate-y-2 transition duration-300">
                    <div class="absolute -top-6 left-1/2 -translate-x-1/2 silver-gradient w-12 h-12 rounded-full flex items-center justify-center text-white font-bold shadow-lg text-lg">2</div>
                    <img src="https://cdn-icons-png.flaticon.com/512/2922/2922510.png" class="w-16 h-16 mx-auto rounded-full border-4 border-gray-200 mb-2">
                    <h3 class="font-bold text-slate-800 text-sm leading-tight">Abdullah R.</h3>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Royal College</p>
                    <div class="mt-2 bg-slate-100 rounded-lg py-1 text-xs font-bold text-slate-600">9,850 Pts</div>
                </div>
                <div class="bg-gray-200 h-16 w-full rounded-t-xl mt-2 mx-auto opacity-50"></div>
            </div>

            <!-- Rank 1 -->
            <div class="relative order-2">
                <div class="absolute -top-12 left-1/2 -translate-x-1/2 text-4xl animate-pulse">üëë</div>
                <div class="bg-white rounded-3xl p-6 shadow-2xl border-b-8 border-yellow-400 text-center relative z-10 transform scale-110 hover:-translate-y-2 transition duration-300">
                    <div class="absolute -top-6 left-1/2 -translate-x-1/2 gold-gradient w-14 h-14 rounded-full flex items-center justify-center text-white font-bold shadow-lg text-xl">1</div>
                    <img src="https://cdn-icons-png.flaticon.com/512/4086/4086679.png" class="w-20 h-20 mx-auto rounded-full border-4 border-yellow-200 mb-3">
                    <h3 class="font-bold text-slate-800 text-base leading-tight">Senuri Perera</h3>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Visakha Vidyalaya</p>
                    <div class="mt-2 bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-lg py-1 text-sm font-bold">10,000 Pts</div>
                </div>
                <div class="gold-gradient h-24 w-full rounded-t-xl mt-2 mx-auto shadow-lg">
                    <div class="text-center text-white/80 font-bold pt-4 text-xs tracking-widest">ISLAND 1ST</div>
                </div>
            </div>

            <!-- Rank 3 -->
            <div class="relative order-3">
                <div class="bg-white rounded-3xl p-4 shadow-xl border-b-8 border-orange-200 text-center relative z-10 transform hover:-translate-y-2 transition duration-300">
                    <div class="absolute -top-6 left-1/2 -translate-x-1/2 bronze-gradient w-12 h-12 rounded-full flex items-center justify-center text-white font-bold shadow-lg text-lg">3</div>
                    <img src="https://cdn-icons-png.flaticon.com/512/2922/2922561.png" class="w-16 h-16 mx-auto rounded-full border-4 border-orange-100 mb-2">
                    <h3 class="font-bold text-slate-800 text-sm leading-tight">Thenuka D.</h3>
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Ananda College</p>
                    <div class="mt-2 bg-orange-50 rounded-lg py-1 text-xs font-bold text-orange-800">9,720 Pts</div>
                </div>
                <div class="bg-orange-200 h-10 w-full rounded-t-xl mt-2 mx-auto opacity-50"></div>
            </div>
        </div>

        <!-- TOP 100 LIST -->
        <div class="max-w-2xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
            <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">üèÜ Top 100 Leaderboard</h3>
                <button @click="user ? changeView('dashboard') : login()" class="text-blue-600 text-xs font-bold hover:underline">Join the List</button>
            </div>
            
            <div class="divide-y divide-slate-50 max-h-[500px] overflow-y-auto">
                <template x-for="(student, index) in displayLeaderboard" :key="index">
                    <!-- Skip Top 3 in list as they are on podium -->
                    <div x-show="index > 2" class="p-4 flex items-center gap-4 hover:bg-slate-50 transition">
                        <div class="font-bold text-slate-300 w-8 text-center" x-text="index + 1"></div>
                        <img :src="student.photo" class="w-10 h-10 rounded-full border border-slate-100">
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800 text-sm" x-text="student.name"></h4>
                            <div class="flex gap-2">
                                <span class="text-[10px] font-bold text-slate-400 uppercase" x-text="student.school"></span>
                                <span class="text-[10px] bg-slate-100 px-1 rounded text-slate-500" x-text="student.code"></span>
                            </div>
                        </div>
                        <div class="font-bold text-slate-800" x-text="student.score"></div>
                    </div>
                </template>
            </div>
            <div class="p-4 bg-slate-50 text-center border-t border-slate-100">
                <button @click="searchModal = true" class="text-blue-600 font-bold text-sm">See All Students ‚Üì</button>
            </div>
        </div>

        <!-- FLOATING CTA -->
        <div class="fixed bottom-6 left-0 w-full px-4 z-40">
            <button @click="user ? changeView('dashboard') : login()" class="w-full max-w-md mx-auto bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-2xl flex items-center justify-center gap-2 btn-press">
                Start My Child's Test üöÄ
            </button>
        </div>
    </div>

    <!-- ================== VIEW: DASHBOARD ================== -->
    <div x-show="view === 'dashboard'" class="pt-24 pb-24 px-4 max-w-md mx-auto fade-in">
        
        <!-- PROFILE HEADER -->
        <div class="bg-white p-6 rounded-3xl shadow-xl mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-10 -mt-10 blur-2xl"></div>
            <div class="relative z-10 flex items-center gap-4">
                <img :src="profile?.photo || user?.photoURL" class="w-20 h-20 rounded-2xl border-4 border-white shadow-lg bg-white object-cover">
                <div>
                    <h2 class="text-xl font-bold text-slate-800" x-text="profile?.childName || 'Loading...'"></h2>
                    <p class="text-xs text-slate-500 font-bold mb-2" x-text="profile?.school || 'Completing Profile...'"></p>
                    <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded-md">
                        ID: <span x-text="profile?.childCode"></span>
                    </span>
                </div>
            </div>
            
            <!-- STATS GRID -->
            <div class="grid grid-cols-2 gap-3 mt-6">
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">National Rank</p>
                    <p class="text-2xl font-black text-blue-600">#<span x-text="profile?.rank || '---'"></span></p>
                </div>
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-center">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Total Score</p>
                    <p class="text-2xl font-black text-slate-800" x-text="profile?.totalScore || 0"></p>
                </div>
            </div>
        </div>

        <!-- PAYMENT BANNER (Smart Logic) -->
        <div x-show="profile?.status === 'free'" @click="showPayment = true" class="relative group cursor-pointer mb-8">
            <div class="absolute -inset-1 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl blur opacity-75 group-hover:opacity-100 transition duration-200"></div>
            <div class="relative bg-white p-5 rounded-2xl flex items-center justify-between">
                <div>
                    <h3 class="font-bold text-slate-800">Unlock Full Report üîí</h3>
                    <p class="text-xs text-slate-500">Get Certificate & National Rank</p>
                </div>
                <div class="bg-yellow-100 text-yellow-800 font-bold px-3 py-1 rounded-lg text-sm">Rs. 490</div>
            </div>
        </div>

        <!-- LIVE TOP 10 DASHBOARD WIDGET -->
        <div class="mb-8">
            <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Live Top 10
            </h3>
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 space-y-3">
                <template x-for="(student, i) in displayLeaderboard.slice(0,10)" :key="i">
                    <div class="flex items-center gap-3 text-xs">
                        <span class="font-bold w-4" :class="i<3 ? 'text-yellow-500' : 'text-slate-300'" x-text="i+1"></span>
                        <img :src="student.photo" class="w-6 h-6 rounded-full">
                        <span class="flex-1 font-semibold text-slate-700 truncate" x-text="student.name"></span>
                        <span class="font-bold text-slate-900" x-text="student.score"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- GAME MAP -->
        <h3 class="font-bold text-slate-700 mb-4">Exam Papers</h3>
        <div class="space-y-3">
            <template x-for="level in 10">
                <div @click="startLevel(level)" 
                     class="relative p-4 rounded-2xl border-b-4 flex items-center justify-between transition btn-press"
                     :class="isUnlocked(level) ? 'bg-white border-blue-200 shadow-sm cursor-pointer' : 'bg-slate-100 border-slate-200 opacity-60'">
                    
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center font-bold text-xl"
                             :class="isUnlocked(level) ? 'bg-blue-50 text-blue-600' : 'bg-slate-200 text-slate-400'">
                            <span x-text="level"></span>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-700">Level <span x-text="level"></span></h4>
                            <p class="text-[10px] text-slate-400 font-bold uppercase" x-text="level === 1 ? 'Free Entry' : 'Scholarship Standard'"></p>
                        </div>
                    </div>

                    <div x-show="!isUnlocked(level)"><i class="fas fa-lock text-slate-300"></i></div>
                    <div x-show="isUnlocked(level)">
                         <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded" x-text="getScore(level) > 0 ? getScore(level) + ' Pts' : 'PLAY'"></span>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- ================== VIEW: GAME ENGINE (Silicon Valley Design) ================== -->
    <div x-show="view === 'game'" class="fixed inset-0 z-50 bg-white flex flex-col">
        <!-- Background Animations -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="blob bg-blue-100 w-96 h-96 rounded-full -top-20 -left-20 opacity-50"></div>
            <div class="blob bg-yellow-100 w-96 h-96 rounded-full -bottom-20 -right-20 opacity-50"></div>
        </div>

        <!-- HUD -->
        <div class="relative z-10 p-6 flex justify-between items-center">
            <button @click="endGame(false)" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 hover:bg-red-50 hover:text-red-500 transition">
                <i class="fas fa-times"></i>
            </button>
            <div class="bg-white/80 backdrop-blur rounded-full px-4 py-1 border border-white shadow-sm">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Level <span x-text="game.level"></span></span>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 font-bold border-2 border-blue-100">
                <span x-text="game.timeLeft"></span>
            </div>
        </div>

        <!-- Question Area -->
        <div class="relative z-10 flex-1 flex flex-col items-center justify-center p-6">
            <div class="w-full max-w-sm bg-white/60 backdrop-blur-xl rounded-3xl p-10 shadow-2xl border border-white text-center mb-10">
                <p class="text-slate-400 text-xs font-bold uppercase mb-4">Solve Fast!</p>
                <h2 class="text-6xl font-black text-slate-800 tracking-tighter" x-text="game.question"></h2>
            </div>

            <!-- Options Grid -->
            <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
                <template x-for="opt in game.options">
                    <button @click="submitAnswer(opt)" 
                            class="bg-white hover:bg-blue-50 active:bg-blue-100 text-slate-700 hover:text-blue-700 text-3xl font-bold py-8 rounded-2xl shadow-lg border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 transition duration-100 btn-press">
                        <span x-text="opt"></span>
                    </button>
                </template>
            </div>
        </div>
    </div>

    <!-- ================== MODALS ================== -->
    
    <!-- SEARCH MODAL -->
    <div x-show="searchModal" class="fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 relative">
            <button @click="searchModal = false" class="absolute top-4 right-4 text-slate-300 hover:text-slate-500">‚úï</button>
            <h2 class="text-xl font-bold text-slate-800 mb-4">Find Student</h2>
            <div class="flex gap-2 mb-6">
                <input x-model="searchQuery" placeholder="Enter Code (SG-xxxx)" class="flex-1 bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 font-bold outline-none focus:border-blue-500">
                <button @click="searchStudent()" class="bg-blue-600 text-white px-6 rounded-xl font-bold">Search</button>
            </div>
            <!-- Search Result -->
            <div x-show="searchResult" class="bg-blue-50 rounded-2xl p-4 flex items-center gap-4">
                <img :src="searchResult?.photo" class="w-12 h-12 rounded-full border-2 border-white">
                <div>
                    <h4 class="font-bold text-slate-800" x-text="searchResult?.childName"></h4>
                    <p class="text-xs text-slate-500" x-text="searchResult?.school"></p>
                </div>
                <div class="ml-auto font-black text-blue-600 text-xl" x-text="searchResult?.totalScore"></div>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div x-show="showPayment" class="fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 relative overflow-hidden">
            <button @click="showPayment = false" class="absolute top-4 right-4 text-slate-300">‚úï</button>
            <div class="text-center mb-6">
                <div class="inline-block bg-yellow-100 text-yellow-700 p-3 rounded-full mb-3 shadow-inner"><i class="fas fa-lock text-2xl"></i></div>
                <h2 class="text-xl font-bold text-slate-800">Premium Required</h2>
                <p class="text-xs text-slate-500">Unlock Level 2-10 & Get Certified</p>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-xl border-2 border-dashed border-slate-200 text-center mb-4">
                <p class="text-[10px] text-slate-400 uppercase font-bold">Transfer Rs. 490 to:</p>
                <p class="font-bold text-slate-800 text-lg">Sampath Bank</p>
                <p class="text-sm text-slate-600 font-mono select-all">1010 5000 8080</p>
                <p class="text-xs text-slate-500">Name: Sahan Tech</p>
            </div>

            <label class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg text-center cursor-pointer transition">
                <input type="file" @change="handleSlip" accept="image/*" class="hidden">
                <span x-text="uploading ? 'Verifying...' : 'Upload Slip & Unlock üîì'"></span>
            </label>
        </div>
    </div>
    
    <!-- RESULT MODAL -->
    <div x-show="view === 'result'" class="fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center relative">
            <div class="absolute -top-12 left-1/2 -translate-x-1/2">
                <div class="w-24 h-24 bg-yellow-400 rounded-full flex items-center justify-center border-8 border-slate-900 text-5xl shadow-2xl">üèÜ</div>
            </div>
            <h2 class="mt-10 text-2xl font-black text-slate-800">Awesome!</h2>
            <div class="my-6">
                <p class="text-xs text-slate-400 uppercase font-bold">Level Score</p>
                <p class="text-6xl font-black text-blue-600 tracking-tighter" x-text="game.score"></p>
            </div>
            <button @click="saveScore()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl hover:scale-105 transition">Continue</button>
        </div>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAE88FW3US3aZRn5TLEdXkad-jvak3W4yI",
            authDomain: "sahantechhub.firebaseapp.com",
            projectId: "sahantechhub",
            storageBucket: "sahantechhub.firebasestorage.app",
            messagingSenderId: "605792804808",
            appId: "1:605792804808:web:531be19ce5f6a4a17faafd",
            measurementId: "G-JMSXWQ964T"
        };

        const app = initializeApp(firebaseConfig);
        window.fire = { 
            auth: getAuth(app), db: getFirestore(app), storage: getStorage(app), provider: new GoogleAuthProvider(),
            signInWithPopup, signOut, onAuthStateChanged, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, ref, uploadBytes, getDownloadURL
        };
    </script>

    <script>
        function geniusApp() {
            return {
                view: 'landing',
                user: null,
                profile: null,
                searchModal: false,
                searchQuery: '',
                searchResult: null,
                showPayment: false,
                uploading: false,
                
                // LEADERBOARD DATA (Mixed Real + Fake Elite)
                displayLeaderboard: [
                    { name: "Senuri Perera", school: "Visakha Vidyalaya", score: 10000, code: "SG-1092", photo: "https://cdn-icons-png.flaticon.com/512/4086/4086679.png" },
                    { name: "Abdullah Razeek", school: "Royal College", score: 9850, code: "SG-2100", photo: "https://cdn-icons-png.flaticon.com/512/2922/2922510.png" },
                    { name: "Thenuka De Silva", school: "Ananda College", score: 9720, code: "SG-3321", photo: "https://cdn-icons-png.flaticon.com/512/2922/2922561.png" },
                    { name: "Kavindi J.", school: "Museus College", score: 9600, code: "SG-4410", photo: "https://cdn-icons-png.flaticon.com/512/4086/4086577.png" },
                    { name: "Sahan G.", school: "D.S. Senanayake", score: 9550, code: "SG-5501", photo: "https://cdn-icons-png.flaticon.com/512/2922/2922656.png" },
                    // ... Add 95 more here if you want, but 5-10 is enough for visual proof
                ],

                game: { level: 1, score: 0, timeLeft: 0, question: '', options: [], correct: 0, timer: null },

                initApp() {
                    setTimeout(() => {
                        window.fire.onAuthStateChanged(window.fire.auth, async (u) => {
                            this.user = u;
                            if(u) await this.fetchProfile();
                        });
                    }, 500);
                },

                changeView(v) { this.view = v; window.scrollTo(0,0); },

                async login() {
                    try { await window.fire.signInWithPopup(window.fire.auth, window.fire.provider); } 
                    catch(e) { console.error(e); }
                },

                async fetchProfile() {
                    const snap = await window.fire.getDoc(window.fire.doc(window.fire.db, "students", this.user.uid));
                    if(snap.exists()) {
                        this.profile = snap.data();
                    } else {
                        // Create Default Profile
                        const code = "SG-" + Math.floor(1000 + Math.random() * 9000);
                        const data = {
                            uid: this.user.uid,
                            childCode: code,
                            childName: this.user.displayName,
                            status: 'free',
                            totalScore: 0,
                            photo: this.user.photoURL,
                            rank: Math.floor(Math.random() * 500) + 100
                        };
                        await window.fire.setDoc(window.fire.doc(window.fire.db, "students", this.user.uid), data);
                        this.profile = data;
                    }
                },

                // SEARCH LOGIC
                async searchStudent() {
                    if(!this.searchQuery) return;
                    this.searchModal = true;
                    this.searchResult = null;
                    
                    // 1. Check Fake Data first (Fast)
                    const fake = this.displayLeaderboard.find(s => s.code === this.searchQuery);
                    if(fake) {
                        this.searchResult = { childName: fake.name, school: fake.school, totalScore: fake.score, photo: fake.photo };
                        return;
                    }

                    // 2. Check Real DB
                    const q = window.fire.query(window.fire.collection(window.fire.db, "students"), window.fire.where("childCode", "==", this.searchQuery));
                    const snap = await window.fire.getDocs(q);
                    if(!snap.empty) {
                        this.searchResult = snap.docs[0].data();
                    } else {
                        alert("Student Code not found!");
                        this.searchModal = false;
                    }
                },

                // GAME & PAYMENT LOGIC
                isUnlocked(lvl) {
                    if(lvl === 1) return true;
                    if(!this.profile) return false;
                    return (this.profile.status === 'paid' || this.profile.status === 'pending');
                },
                getScore(lvl) { return this.profile?.levelScores?.[lvl] || 0; },
                
                async handleSlip(e) {
                    const file = e.target.files[0];
                    if(!file) return;
                    this.uploading = true;
                    try {
                        const fileRef = window.fire.ref(window.fire.storage, `slips/${this.user.uid}_${Date.now()}`);
                        await window.fire.uploadBytes(fileRef, file);
                        const url = await window.fire.getDownloadURL(fileRef);
                        
                        await window.fire.updateDoc(window.fire.doc(window.fire.db, "students", this.user.uid), {
                            status: 'pending', paymentProof: url
                        });
                        this.profile.status = 'pending';
                        this.showPayment = false;
                        alert("‚úÖ Slip Uploaded! All Levels Unlocked.");
                    } catch(e) { console.error(e); alert("Upload failed"); }
                    this.uploading = false;
                },

                // GAME ENGINE (Silicon Valley Polish)
                startLevel(lvl) {
                    if(!this.isUnlocked(lvl)) { this.showPayment = true; return; }
                    this.view = 'game';
                    this.game.level = lvl;
                    this.game.score = 0;
                    this.game.timeLeft = 60;
                    this.nextQuestion();
                    if(this.game.timer) clearInterval(this.game.timer);
                    this.game.timer = setInterval(() => {
                        this.game.timeLeft--;
                        if(this.game.timeLeft <= 0) this.endGame(true);
                    }, 1000);
                },
                nextQuestion() {
                    let limit = this.game.level * 10;
                    let n1 = Math.floor(Math.random() * limit) + 2;
                    let n2 = Math.floor(Math.random() * limit) + 2;
                    this.game.correct = n1 + n2; // Simple math for demo
                    this.game.question = `${n1} + ${n2}`;
                    
                    let opts = new Set([this.game.correct]);
                    while(opts.size < 4) opts.add(this.game.correct + (Math.floor(Math.random() * 10) - 5));
                    this.game.options = Array.from(opts).sort(() => Math.random() - 0.5);
                },
                submitAnswer(ans) {
                    if(ans === this.game.correct) {
                        this.game.score += 10;
                        confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 } });
                    } else {
                        // Shake effect (optional)
                    }
                    this.nextQuestion();
                },
                endGame(save) {
                    clearInterval(this.game.timer);
                    if(save) this.view = 'result';
                    else this.view = 'dashboard';
                },
                async saveScore() {
                    let scores = this.profile.levelScores || {};
                    if(this.game.score > (scores[this.game.level] || 0)) {
                        scores[this.game.level] = this.game.score;
                        let total = Object.values(scores).reduce((a, b) => a + b, 0);
                        await window.fire.updateDoc(window.fire.doc(window.fire.db, "students", this.user.uid), {
                            levelScores: scores, totalScore: total
                        });
                        this.profile.levelScores = scores;
                        this.profile.totalScore = total;
                    }
                    this.view = 'dashboard';
                }
            }
        }
    </script>
</body>
</html>
